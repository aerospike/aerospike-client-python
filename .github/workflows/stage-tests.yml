name: Stage tests

# Downloads artifacts either from Github or JFrog
# and runs category 1 (source distribution) and category 2 (binary distribution) tests
# The purpose is to test that our artifacts work on the Linux distros / OS versions that the client supports
# and QE doesn't have disk space for more Linux distros, so we have some tests in Github Actions

on:
  workflow_call:
    inputs:
      # Same strategy as workflow_call hack
      # See details in update-version workflow
      use_jfrog_builds:
        description: If false, download artifacts from Github
        required: true
        type: boolean
        default: true
      jfrog-build-version-to-test:
        description: Used only when use_jfrog_builds is true.
        type: string
        required: false
      # These will be set if use_jfrog_builds is false (i.e when someone is building and testing the artifacts in a workflow dispatch event)
      # If use_jfrog_builds is true, only the defaults will be used
      use-server-rc:
        type: boolean
        required: false
        default: false
        description: 'Test against server release candidate?'
      server-tag:
        type: string
        required: false
        default: 'latest'
        description: 'Server docker image tag'
      test-macos-x86:
        required: false
        type: boolean
        default: false
        description: 'Test macOS x86 wheels (unstable)'

jobs:
  sdist-tests:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        distros: [
          # Docker image name, container name
          ["redhat/ubi9", "RHEL9"],
          ["amazonlinux:2023", "AmazonLinux2023"]
        ]
        python-version: [
          '3.9',
        ]
      fail-fast: false
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ inputs.use_jfrog_builds && inputs.jfrog-build-version-to-test || github.sha }}

    - uses: ./.github/actions/run-ee-server
      with:
        use-server-rc: ${{ inputs.use-server-rc }}
        server-tag: ${{ inputs.server-tag }}
        docker-hub-username: ${{ secrets.DOCKER_HUB_BOT_USERNAME }}
        docker-hub-password: ${{ secrets.DOCKER_HUB_BOT_PW }}

    - if: ${{ !inputs.use_jfrog_builds }}
      uses: actions/download-artifact@v4
      with:
        name: sdist.build

    # TODO: JFrog code is repeated throughout this workflow
    # But it will be refactored later

    - if: ${{ inputs.use_jfrog_builds }}
      uses: jfrog/setup-jfrog-cli@v4
      env:
        JF_URL: ${{ secrets.JFROG_PLATFORM_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}

    - if: ${{ inputs.use_jfrog_builds }}
      name: Download JFrog build
      run: jf rt dl --flat --build python-client/${{ inputs.jfrog-build-version-to-test }} "${{ vars.JFROG_REPO_NAME }}/**/*.tar.gz"

    - name: Run distro container
      run: docker run --name ${{ matrix.distros[1] }} --network host --detach ${{ matrix.distros[0] }} tail -f /dev/null

    - name: Copy repo to container
      run: docker cp . ${{ matrix.distros[1] }}:/aerospike-client-python

    - name: Install python 3.11 if applicable
      run: docker exec ${{ matrix.distros[1] }} yum install -y python3.11
      if: ${{ matrix.python-version == '3.11' }}

    - name: Install build dependencies
      run: docker exec ${{ matrix.distros[1] }} yum install -y openssl-devel glibc-devel autoconf automake libtool zlib-devel openssl-devel python-devel

    - name: Make sure pip is installed
      run: docker exec ${{ matrix.distros[1] }} python${{ matrix.python-version }} -m ensurepip

    - name: Install more build dependencies using pip
      run: docker exec --workdir /aerospike-client-python/ ${{ matrix.distros[1] }} python${{ matrix.python-version }} -m pip install -r requirements.txt

    - name: Install source distribution
      run: docker exec --workdir /aerospike-client-python/ ${{ matrix.distros[1] }} python${{ matrix.python-version }} -m pip install *.tar.gz

    - name: Install test dependencies
      run: docker exec --workdir /aerospike-client-python/test ${{ matrix.distros[1] }} python${{ matrix.python-version }} -m pip install pytest -c requirements.txt

    - name: Run tests
      id: test
      run: docker exec --workdir /aerospike-client-python/test ${{ matrix.distros[1] }} python${{ matrix.python-version }} -m pytest new_tests/

  # These tests use a Docker container to run the distro
  wheel-tests:
    strategy:
      matrix:
        platform: [
          # Platform in artifact file name, Docker platform
          ["x86_64", "linux/amd64"],
          ["aarch64", "linux/arm64"],
        ]
        include:
          - distro: amazonlinux:2023
            python-version: ["3.9", "cp39"]
          - distro: amazonlinux:2023
            python-version: ["3.11", "cp311"]
          - distro: ubuntu:22.04
            python-version: ["3.10", "cp310"]
          - distro: python:3.8
            python-version: ["3.8", "cp38"]
          - distro: python:3.9
            python-version: ["3.9", "cp39"]
          - distro: python:3.10
            python-version: ["3.10", "cp310"]
          - distro: python:3.11
            python-version: ["3.11", "cp311"]
          - distro: python:3.12
            python-version: ["3.12", "cp312"]
      fail-fast: false
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.use_jfrog_builds && inputs.jfrog-build-version-to-test || github.sha }}

    - uses: actions/download-artifact@v4
      if: ${{ !inputs.use_jfrog_builds }}
      with:
        name: ${{ matrix.python-version[1] }}-manylinux_${{ matrix.platform[0] }}.build

    - uses: jfrog/setup-jfrog-cli@v4
      if: ${{ inputs.use_jfrog_builds }}
      env:
        JF_URL: ${{ secrets.JFROG_PLATFORM_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}

    - name: Download JFrog build
      if: ${{ inputs.use_jfrog_builds }}
      run: jf rt dl --flat --build python-client/${{ inputs.jfrog-build-version-to-test }} "${{ vars.JFROG_REPO_NAME }}/**/*${{ matrix.python-version[1] }}*manylinux*${{ matrix.platform[0] }}.whl"

    - name: Set up QEMU for cross compiling arm64
      if: ${{ matrix.platform[0] == 'aarch64' }}
      uses: docker/setup-qemu-action@v2
      with:
        platforms: arm64

    - uses: ./.github/actions/run-ee-server
      with:
        use-server-rc: ${{ inputs.use-server-rc }}
        server-tag: ${{ inputs.server-tag }}
        docker-hub-username: ${{ secrets.DOCKER_HUB_BOT_USERNAME }}
        docker-hub-password: ${{ secrets.DOCKER_HUB_BOT_PW }}

    - name: Get distro container name
      run: echo DISTRO_CONTAINER_NAME="distro-container" >> $GITHUB_ENV

    - name: Run distro container
      # Run distro container on host network to access the server Docker container using localhost
      run: docker run --name ${{ env.DISTRO_CONTAINER_NAME }} --platform ${{ matrix.platform[1] }} --network host --detach ${{ matrix.distro }} tail -f /dev/null

    - name: Copy repo to container
      run: docker cp . ${{ env.DISTRO_CONTAINER_NAME }}:/aerospike-client-python

    - name: 'Amazon Linux 2023: install python 3.11 if applicable'
      if: ${{ matrix.distro == 'amazonlinux:2023' && matrix.python-version[0] == '3.11' }}
      run: docker exec ${{ env.DISTRO_CONTAINER_NAME }} yum install -y python3.11

    - name: 'Ubuntu 22.04 Install python 3.10 that comes by default (step 1)'
      if: ${{ matrix.distro == 'ubuntu:22.04' }}
      run: docker exec ${{ env.DISTRO_CONTAINER_NAME }} apt update

    - name: 'Ubuntu 22.04 Install python 3.10 that comes by default (step 2)'
      if: ${{ matrix.distro == 'ubuntu:22.04' }}
      run: docker exec ${{ env.DISTRO_CONTAINER_NAME }} apt install python3 python3-pip -y

    - name: Make sure pip is installed
      if: ${{ matrix.distro == 'amazonlinux:2023' || startsWith(matrix.distro, 'python') }}
      run: docker exec ${{ env.DISTRO_CONTAINER_NAME }} python${{ matrix.python-version[0] }} -m ensurepip

    - name: Install wheel
      run: docker exec --workdir /aerospike-client-python/ ${{ env.DISTRO_CONTAINER_NAME }} python${{ matrix.python-version[0] }} -m pip install *.whl

    - name: Install pytest
      run: docker exec --workdir /aerospike-client-python/test ${{ env.DISTRO_CONTAINER_NAME }} python${{ matrix.python-version[0] }} -m pip install pytest -c requirements.txt

    - name: Run tests
      id: test
      run: docker exec --workdir /aerospike-client-python/test ${{ env.DISTRO_CONTAINER_NAME }} python${{ matrix.python-version[0] }} -m pytest new_tests/

  macOS:
    if: ${{ inputs.test-macos-x86 }}
    strategy:
      matrix:
        macos-version: [
          'macos-13',
          'macos-14-large'
        ]
        python-version: [
          ["3.8", "cp38"],
          ["3.9", "cp39"],
          ["3.10", "cp310"],
          ["3.11", "cp311"],
          ["3.12", "cp312"]
        ]
      fail-fast: false
    runs-on: ${{ matrix.macos-version }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.use_jfrog_builds && inputs.jfrog-build-version-to-test || github.sha }}

    - uses: actions/download-artifact@v4
      if: ${{ !inputs.use_jfrog_builds }}
      with:
        name: ${{ matrix.python-version[1] }}-macosx_x86_64.build

    - uses: jfrog/setup-jfrog-cli@v4
      if: ${{ inputs.use_jfrog_builds }}
      env:
        JF_URL: ${{ secrets.JFROG_PLATFORM_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}

    - name: Download JFrog build
      if: ${{ inputs.use_jfrog_builds }}
      run: jf rt dl --flat --build python-client/${{ inputs.jfrog-build-version-to-test }} "${{ vars.JFROG_REPO_NAME }}/**/*${{ matrix.python-version[1] }}*macosx*x86_64.whl"

    - uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version[0] }}

    - name: Install Docker Engine
      run: brew install colima

    - name: Install Docker client
      run: brew install docker

    - name: Start Docker Engine
      run: colima start

    - uses: ./.github/actions/run-ee-server
      with:
        use-server-rc: ${{ inputs.use-server-rc }}
        server-tag: ${{ inputs.server-tag }}
        docker-hub-username: ${{ secrets.DOCKER_HUB_BOT_USERNAME }}
        docker-hub-password: ${{ secrets.DOCKER_HUB_BOT_PW }}

    - name: Wait for server to be ready
      run: sleep 5

    - name: Install wheel
      run: python3 -m pip install *.whl

    - name: Install test dependencies
      run: python3 -m pip install pytest -c requirements.txt
      working-directory: test

    - name: Run tests
      run: python3 -m pytest new_tests/
      id: test
      working-directory: test
