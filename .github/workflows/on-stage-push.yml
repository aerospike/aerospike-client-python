name: Stage tests

on:
  push:
    branches:
    - 'stage'
  workflow_dispatch:
    inputs:
      # For creating a backport client version
      server-tag:
        required: true
        default: 'latest'
        description: 'Server docker image tag'

jobs:
  promote-dev-build-to-rc:
    uses: ./.github/workflows/bump-version.yml
    with:
      change: 'promote-dev-build-to-rc'
    secrets:
      CLIENT_BOT_PAT: ${{ secrets.CLIENT_BOT_PAT }}

  build-rc-artifacts:
    name: Build RC artifacts
    needs: promote-dev-build-to-rc
    uses: ./.github/workflows/build-wheels.yml
    with:
      server-tag: ${{ inputs.server-tag }}
      run_tests: true
      commit_sha: ${{ needs.promote-dev-build-to-rc.outputs.bump_sha }}

  upload-to-jfrog:
    name: Upload artifacts to JFrog
    needs: [
      build-rc-artifacts,
      promote-dev-build-to-rc
    ]
    uses: ./.github/workflows/upload-to-jfrog.yml
    with:
      new_version: ${{ needs.promote-dev-build-to-rc.outputs.new_version }}
    secrets:
      JFROG_PLATFORM_URL: ${{ secrets.JFROG_PLATFORM_URL }}
      JFROG_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}

  run-stage-tests:
    needs: [
      upload-to-jfrog,
      promote-dev-build-to-rc
    ]
    uses: ./.github/workflows/stage-tests.yml
    with:
      commit_sha: ${{ needs.promote-dev-build-to-rc.outputs.bump_sha }}
