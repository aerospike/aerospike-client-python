name: Build and upload release artifacts to JFrog
on:
  push:
    branches:
    - 'master'
    # This is to make sure this workflow doesn't get triggered after a bump commit
    tags-ignore:
    - '*'
  workflow_dispatch:

jobs:
  promote-rc-build-to-release:
    uses: ./.github/workflows/bump-version.yml
    with:
      change: promote-rc-build-to-release

  build-artifacts:
    needs: promote-rc-build-to-release
    uses: ./.github/workflows/build-wheels.yml
    with:
      run_tests: false
      commit_sha: ${{ needs.promote-rc-build-to-release.outputs.bump_sha }}

  upload-to-jfrog:
    name: Upload artifacts to JFrog
    needs: build-artifacts
    uses: ./.github/workflows/upload-to-jfrog.yml
    with:
      new_version: ${{ needs.promote-rc-build-to-release.outputs.new_version }}
    secrets:
      JFROG_PLATFORM_URL: ${{ secrets.JFROG_PLATFORM_URL }}
      JFROG_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}

  publish-to-pypi:
    runs-on: ubuntu-latest
    needs: build-artifacts
    steps:
    - name: Download and store all artifacts to single folder
      run: ./.github/actions/dl-and-unwrap-artifacts

    - name: Publish package distributions to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: artifacts/
        password: ${{ secrets.PYPI_API_TOKEN }}

  set-new-rc-and-dev-number-in-dev:
    needs: upload-to-jfrog
    uses: ./.github/workflows/bump-version.yml
    with:
      change: 'set-new-rc-and-dev-number-in-dev'
      commit_sha: dev
    secrets: inherit
