name: Build artifacts
run-name: Build artifacts (run_tests=${{ inputs.run_tests }}, use-server-rc=${{ inputs.use-server-rc }}, server-tag=${{ inputs.server-tag }})

# Builds manylinux wheels and source distribution
# Optionally run tests on manylinux wheels
# Then upload artifacts to Github

on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: "Run integration tests with the wheels after building them"
        required: true
        type: boolean
        default: false
      use-server-rc:
        type: boolean
        required: true
        default: false
        description: 'Test against server release candidate? (e.g to test new server features)'
      server-tag:
        type: string
        required: true
        default: 'latest'
        description: 'Server docker image tag (e.g to test a client backport version)'

  workflow_call:
    inputs:
      # The "dev" tests test the artifacts against a server
      # The dev-to-stage and stage-to-master workflow only need to build the artifacts, not test them
      run_tests:
        required: false
        type: boolean
        default: false
      # workflow_call hack
      is_workflow_call:
        type: boolean
        default: true
        required: false
      # This input is only used in workflow_call events
      sha-to-build-and-test-override:
        description: Some calling workflows want to specifically test on a different branch than the one the workflow is called from
        type: string
        default: ${{ github.sha }}
        required: false
      # A calling workflow doesn't actually set values to the inputs below
      # But the workflow we need to have default values for these inputs
      use-server-rc:
        required: false
        default: false
        type: boolean
      server-tag:
        type: string
        required: false
        default: 'latest'
    secrets:
      DOCKER_HUB_BOT_USERNAME:
        required: false
      DOCKER_HUB_BOT_PW:
        required: false
      MAC_M1_SELF_HOSTED_RUNNER_PW:
        required: false

jobs:
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-22.04
    steps:
    - name: Get commit sha to show status check
      # A workflow_dispatch event doesn't have the sha-to-build-and-test-override input
      # So for a workflow_dispatch event, we want to use the github commit hash that triggered it
      run: echo COMMIT_SHA_FOR_STATUS_CHECK=${{ inputs.is_workflow_call == true && inputs.sha-to-build-and-test-override || github.sha }} >> $GITHUB_ENV
      shell: bash

    - name: Create status check message
      run: echo STATUS_CHECK_MESSAGE="cibuildwheel (sdist)" >> $GITHUB_ENV
      shell: bash

    - name: Show job status for commit
      # Commit status will already be shown by the calling workflow for push and pull request events, but not
      # for any other event like workflow_dispatch. so we have to do it manually
      # If workflow_call triggered this job, github.event_name will inherit the event of the calling workflow
      # The calling workflow can be triggered by push or pull request events, so there's that
      # https://github.com/actions/runner/issues/3146#issuecomment-2000017097
      if: ${{ github.event_name != 'push' && github.event_name != 'pull_request' }}
      uses: myrotvorets/set-commit-status-action@v2.0.0
      with:
        sha: ${{ env.COMMIT_SHA_FOR_STATUS_CHECK }}
        context: ${{ env.STATUS_CHECK_MESSAGE }}

    - uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.COMMIT_SHA_FOR_STATUS_CHECK }}
        fetch-depth: 0

    - name: Install build dependencies (pip packages)
      run: python3 -m pip install -r requirements.txt

    - name: Build source distribution
      run: python3 -m build --sdist

    - name: Upload source distribution to GitHub
      uses: actions/upload-artifact@v4
      with:
        path: ./dist/*.tar.gz
        name: sdist.build

    - name: Set final commit status
      uses: myrotvorets/set-commit-status-action@v2.0.0
      # Always run even if job failed or is cancelled
      # But we don't want to show anything if the calling workflow was triggered by these events
      if: ${{ always() && github.event_name != 'push' && github.event_name != 'pull_request' }}
      with:
        sha: ${{ env.COMMIT_SHA_FOR_STATUS_CHECK }}
        status: ${{ job.status }}
        context: ${{ env.STATUS_CHECK_MESSAGE }}

  build-wheels:
    strategy:
      matrix:
        platform-tag-and-runner-os: [
          ["manylinux_x86_64", "ubuntu-22.04"],
          ["manylinux_aarch64", "ubuntu-22.04"],
          ["macosx_x86_64", "macos-12-large"],
          ["macosx_arm64", "macos-14"],
          ["win_amd64", "windows-2022"]
        ]
      fail-fast: false
    uses: ./.github/workflows/cibuildwheel.yml
    with:
      platform-tag: ${{ matrix.platform-tag-and-runner-os[0] }}
      runner-os: ${{ matrix.platform-tag-and-runner-os[1] }}
      sha-to-build-and-test-override: ${{ inputs.sha-to-build-and-test-override }}
      run_tests: ${{ inputs.run_tests }}
      use-server-rc: ${{ inputs.use-server-rc }}
      server-tag: ${{ inputs.server-tag }}
