# Takes in how to bump version as input
# Commits changes to bump version and outputs the new version and commit hash as output

name: Bump version
on:
  workflow_dispatch:
    inputs:
      change:
        type: choice
        description: Python script name to change version
        required: true
        options:
        - bump-dev-num
        - promote-dev-build-to-rc
        - promote-rc-build-to-release
  workflow_call:
    inputs:
      change:
        # Since workflow_call doesn't support 'options' input type,
        # we take in a string instead that must be a valid python script name (excluding the .py part)
        # Example: bump-dev-num for bump-dev-num.py
        type: string
        description: Python script name to change version
        required: true
      commit_sha:
        required: false
        description: Commit to bump off of
        default: ''
        type: string
    secrets:
      CLIENT_BOT_PAT:
        required: true
    outputs:
      new_version:
        value: ${{ jobs.bump-version.outputs.new_version }}
      bump_sha:
        value: ${{ jobs.bump-version.outputs.bump_sha }}

jobs:
  bump-version:
    name: Bump version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.pass-new-version.outputs.new_version }}
      bump_sha: ${{ steps.pass-bump-commit-sha.outputs.bump_sha }}
    steps:
    # The code to get the new version should be from the branch where we called the workflow
    - uses: actions/checkout@v4

    - run: pip install parver -c requirements.txt
      working-directory: .github/workflows

    - name: Get new version
      run: echo NEW_TAG=$(python3 .github/workflows/${{ inputs.change }}.py $(cat VERSION)) >> $GITHUB_ENV

    # Now checkout the branch we want to bump the new version
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.CLIENT_BOT_PAT }}
        ref: ${{ inputs.commit_sha }}

    - name: Update __version__ in aerospike module
      run: sed -i "s/const char version\[] = \".*\";/const char version\[] = \"${{ env.NEW_TAG }}\";/" src/main/aerospike.c

    - name: Update VERSION metadata
      run: echo ${{ env.NEW_TAG }} > VERSION

    - name: Commit new version
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Auto-bump version to ${{ env.NEW_TAG }}
        commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
        tagging_message: ${{ env.NEW_TAG }}

    - name: Pass new version to JFrog upload job
      id: pass-new-version
      run: echo "new_version=${{ env.NEW_TAG }}" >> $GITHUB_OUTPUT

    # With the push event, the next job will checkout the commit that triggered the workflow
    # instead of the bump commit that was just made
    # So we need to pass the bump commit's hash to the next job so it checks out the right commit
    - name: Pass SHA for bump commit to next job
      id: pass-bump-commit-sha
      run: echo "bump_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
