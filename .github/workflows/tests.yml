name: Pytest Tests

# Trigger test workflow whenever:
# 1. A pull request is updated (e.g with new commits)
# 2. Commits are pushed directly to the stage or master branch
on:
  push:
    branches: ["stage", "master"]
  pull_request:
    branches: ["stage"]
  workflow_dispatch:
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Set up Aerospike Database
      uses: reugn/github-action-aerospike@dev
      with:
        port: 3000
    - uses: actions/setup-python@v2
      with:
        python-version: '3.9'
        architecture: 'x64'
    - name: Install development dependencies
      run: |
        sudo apt-get install libssl-dev
        sudo apt-get install python3-dev
        python -m pip install pytest flake8
    - name: Build client
      run: |
        python3 -m pip install build
        python3 -m build
    - name: Install client
      run: |
        pip install .
    - name: Run tests
      run: |
        cd test
        python -m pytest ./new_tests
    - name: Lint Python code
      run:
        flake8 --count --max-complexity=10 --show-source --max-line-length=127 aerospike_helpers benchmarks
