name: PR pre-merge tests

# Trigger test workflow whenever:
# 1. A pull request is updated (e.g with new commits)
# 2. Commits are pushed directly to the stage or master branch
on:
  push:
    branches: ["stage", "master"]
  pull_request:
    branches: ["stage"]
    types: [
      # Default triggers
      opened,
      synchronize,
      reopened,
      # Additional triggers
      labeled,
      unlabeled
    ]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: actions/setup-python@v2
      with:
        python-version: '3.9'
        architecture: 'x64'
    - uses: pre-commit/action@v3.0.0

  alpine:
    runs-on: ubuntu-latest
    steps:
    - name: Run Aerospike server release candidate with latest tag
      if: ${{ contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -d --name aerospike -p 3000-3002:3000-3002 aerospike.jfrog.io/docker/aerospike/aerospike-server-rc:latest

    - name: Run Aerospike server
      if: ${{ !contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -d --name aerospike -p 3000-3002:3000-3002 aerospike/aerospike-server

    - name: Get server ip
      run: echo SERVER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' aerospike) >> $GITHUB_ENV

    # Use this to get current branch of workflow
    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v4
      with:
        short-length: 8 # Same as v3 and before

    - uses: addnab/docker-run-action@v3
      with:
        image: alpine:latest
        options: -e GITHUB_REF_NAME=${{ env.GITHUB_REF_NAME }} -e SERVER_IP=${{ env.SERVER_IP }}
        run: |
          apk add py3-pip
          apk add python3-dev
          apk add zlib-dev
          apk add git
          # C client dependencies
          apk add automake
          apk add make
          apk add musl-dev
          apk add gcc
          apk add openssl-dev
          apk add lua-dev
          apk add libuv-dev  # (for node.js)
          apk add doxygen  # (for make docs)
          apk add graphviz # (for make docs)

          git clone --recurse-submodules https://github.com/aerospike/aerospike-client-python
          cd aerospike-client-python/
          git checkout $GITHUB_REF_NAME
          git submodule update --recursive

          python3 -m pip install build
          python3 -m build
          python3 -m pip install dist/*.whl
          cd test/
          # requirements.txt is not working atm
          python3 -m pip install pytest

          # Configure tests
          sed -i "s/hosts: 127.0.0.1:3000/hosts: $SERVER_IP:3000/" config.conf

          python3 -m pytest new_tests/

    - name: Cleanup
      run: |
        docker container stop aerospike
        docker container rm aerospike

  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        py-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
      fail-fast: false

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.py-version }}
        architecture: 'x64'

    - run: sudo apt update
    - name: Install build dependencies (apt packages)
      run: sudo apt install python3-dev libssl-dev -y
    - name: Install build dependencies (pip packages)
      run: python3 -m pip install build

    - name: Build client
      run: python3 -m build

    - name: Send wheel to test jobs
      uses: actions/upload-artifact@v3
      with:
        name: wheel-${{ matrix.py-version }}
        path: ./dist/*.whl

  multinode-tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: actions/setup-python@v2
      with:
        python-version: "3.7"
        architecture: 'x64'
    - uses: actions/download-artifact@v3
      with:
        name: wheel-3.7
    - name: Install client
      run: pip install *.whl
    - name: Download aerolab
      run: wget https://github.com/aerospike/aerolab/releases/download/4.5.0/aerolab-linux-amd64.deb
    - name: Install aerolab
      run: sudo dpkg -i aerolab-linux-amd64.deb
    - name: Tell aerolab to use Docker
      run: aerolab config backend -t docker
    - run: pip install docker
    - run: aerolab cluster create --count=2
    - run: sleep 5
    - name: Configure aerospike.conf
      run: |
        # Get first node container ID (strip quotes)
        instanceId=$(aerolab cluster list -j | jq '.[] | select(.NodeNumber=="1") | .InstanceId' | cut -d \" -f2)
        docker exec $instanceId asinfo -v "set-config:context=network;heartbeat.interval=50"
        # Set this config for all nodes
        aerolab files sync --path=/etc/aerospike/aerospike.conf
    - name: Run tests
      run: python3 test/multinode-test.py

  test-ce:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        py-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
      fail-fast: false

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.py-version }}
        architecture: 'x64'

    - uses: actions/download-artifact@v3
      with:
        name: wheel-${{ matrix.py-version }}

    - name: Install client
      run: pip install *.whl

    - name: Install test dependencies
      run: pip install -r test/requirements.txt

    - name: Run Aerospike server release candidate with latest tag
      if: ${{ contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -d --name aerospike -p 3000-3002:3000-3002 aerospike.jfrog.io/docker/aerospike/aerospike-server-rc:latest

    - name: Run Aerospike server
      if: ${{ !contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -d --name aerospike -p 3000-3002:3000-3002 aerospike/aerospike-server

    - name: Wait for database to be ready
      # Should be ready after 3 seconds
      run: sleep 3

    - name: Run tests
      run: python -m pytest ./new_tests
      working-directory: test

  test-ee:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: actions/setup-python@v2
      with:
        python-version: 3.7
        architecture: 'x64'

    - uses: actions/download-artifact@v3
      with:
        name: wheel-3.7

    - name: Install client
      run: pip install *.whl

    - name: Install test dependencies
      run: pip install -r test/requirements.txt

    - name: Install crudini to manipulate config.conf
      run: pip install crudini

    - name: Add enterprise edition config to config.conf
      run: |
        crudini --set config.conf enterprise-edition hosts 127.0.0.1:3000
        crudini --set config.conf enterprise-edition user superuser
        crudini --set config.conf enterprise-edition password superuser
      working-directory: test

    - name: Create config folder to store configs in
      run: mkdir configs

    - name: Run Aerospike server release candidate with latest tag
      if: ${{ contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -d --name aerospike -p 3000-3002:3000-3002 aerospike.jfrog.io/docker/aerospike/aerospike-server-enterprise-rc:latest

    - name: Run Aerospike server
      if: ${{ !contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -d --name aerospike -p 3000-3002:3000-3002 aerospike/aerospike-server-enterprise

    - name: Get default aerospike.conf from Docker server EE container
      run: |
        sleep 5
        docker cp aerospike:/etc/aerospike/aerospike.conf ./configs/aerospike.conf
        docker container stop aerospike
        docker container rm aerospike

    - name: Enable security features using aerospike.conf
      # Security stanza
      run: echo -e "security {\n\n}\n" >> ./aerospike.conf
      working-directory: ./configs

    - name: Run Aerospike server release candidate with latest tag
      if: ${{ contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -tid -v $(pwd)/configs:/opt/aerospike/etc -p 3000:3000 --name aerospike aerospike.jfrog.io/docker/aerospike/aerospike-server-enterprise-rc:latest asd --config-file /opt/aerospike/etc/aerospike.conf

    - name: Run enterprise edition server
      if: ${{ !contains(github.event.pull_request.labels.*.name, 'new-server-features') }}
      run: docker run -tid -v $(pwd)/configs:/opt/aerospike/etc -p 3000:3000 --name aerospike aerospike/aerospike-server-enterprise:latest asd --config-file /opt/aerospike/etc/aerospike.conf

    - name: Wait for server to start
      run: sleep 5

    - name: Create user in database for tests
      # Use default admin user to create another user for testing
      run: docker exec aerospike asadm --user admin --password admin --enable -e "manage acl create user superuser password superuser roles read-write-udf sys-admin user-admin data-admin"

    - name: Run tests
      run: python -m pytest ./new_tests/test_admin_*.py
      working-directory: test

    - name: Show logs if failed
      if: ${{ failure() }}
      run: |
        docker container logs aerospike
        cat ./configs/aerospike.conf

  spellcheck-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: actions/setup-python@v2
      with:
        python-version: '3.9'
        architecture: 'x64'
    - name: Install dependencies for checking spelling in docs
      # TODO: find way to split up dependencies
      run: python -m pip install -r doc/requirements.txt
    - name: Check spelling
      run: sphinx-build -b spelling . spelling -W --keep-going
      working-directory: doc

  check-links-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: '3.9'
        architecture: 'x64'
    - name: Install documentation dependencies
      run: python -m pip install -r doc/requirements.txt
    - name: Check spelling
      run: sphinx-build -b linkcheck . links
      working-directory: doc
